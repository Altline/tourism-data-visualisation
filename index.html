<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />

    <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Turizam u svijetu</title>
</head>

<body>
    <div id="map">
        <svg id="mapSvg" viewBox="0 0 1000 1000" width="100%" height="100%"></svg>
    </div>

    <div id="sidebar">

        <label id="yearLabel" for="yearInput"></label>
        <input id="yearInput" type="range" min="1995" max="2018">

        <div class="sidebar-row">
            <h4 id="countryLabel"></h4>
            <h4 id="countryTourism"></h4>
        </div>
        <canvas id="historyChart" width="100%" height="auto"></canvas>

    </div>

    <script type="module">

        // Functions

        async function loadData(path) {
            var data;
            await d3.json(path).then((loadedData) => {
                data = loadedData;
            });
            return data;
        }

        function findGlobalExtremes(tourismData) {
            let min = Number.MAX_VALUE;
            let max = -1;
            for (let year = 1995; year <= 2018; year++) {
                tourismData.forEach((d) => {
                    const num = d[year];
                    if (num && num != "") {
                        if (num < min) min = num;
                        if (num > max) max = num;
                    }
                });
            }
            return [min, max];
        }

        function findTourismByCountryName(tourismData, countryName) {
            return tourismData.find((d) => {
                return d["Country_Name"] == countryName;
            });
        }

        function updateAll(year, country) {
            selectedYear = year;
            selectedCountry = country;
            worldMap.update(year, country);
            sidebar.update(year, country);
        }


        // Classes

        class WorldMap {

            constructor() {
                this.svg = d3.select("#mapSvg");
                this.g = this.svg.append("g");

                const zoom = d3.zoom()
                    .scaleExtent([1, 80])
                    .on('zoom', (event) => {
                        this.g.selectAll('path')
                            .attr('transform', event.transform);
                    });
                this.svg.call(zoom);

                this.svg.on("click", (e) => {
                    if (e.target.tagName == "svg") {
                        updateAll(selectedYear, null);
                    }
                })

                this.tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");

                const [minTourism, maxTourism] = findGlobalExtremes(tourismData);

                this.colors = d3.scaleLinear()
                    .domain([minTourism, maxTourism])
                    .range(["white", "blue"]);

                const projection = d3.geoEquirectangular()
                    .center([-5, 70])
                    .scale(200);

                const path = d3.geoPath()
                    .projection(projection);

                const data = topojson.feature(mapData, mapData.objects.countries);
                this.g.selectAll("path.country")
                    .data(data.features)
                    .enter()
                    .append("path")
                    .attr("class", "country")
                    .attr("id", (d) => { return d.id; })
                    .attr("d", path)
                    .on("mouseover", (e) => {
                        const countryName = e.target.__data__.properties.name;
                        const tourism = findTourismByCountryName(tourismData, countryName);

                        this.tooltip.html(
                            countryName + "<br/>" +
                            (tourism && tourism[selectedYear] ? d3.format(".3s")(tourism[selectedYear]) : "")
                        )
                            .style("left", (e.pageX + 10) + "px")
                            .style("top", (e.pageY - 30) + "px");

                        this.tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);

                        if (tourism != selectedCountry) {
                            e.target.style.strokeWidth = "1.5px";
                        }
                    })
                    .on("mouseout", (e) => {
                        this.tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);

                        const countryName = e.target.__data__.properties.name;
                        const tourism = findTourismByCountryName(tourismData, countryName);

                        if (tourism != selectedCountry) {
                            e.target.style.strokeWidth = "0.25px";
                        }
                    })
                    .on("click", (e) => {
                        const countryName = e.target.__data__.properties.name;
                        const tourism = findTourismByCountryName(tourismData, countryName);
                        updateAll(selectedYear, tourism);
                    });
            }

            update() {
                const data = topojson.feature(mapData, mapData.objects.countries);
                this.g.selectAll("path.country")
                    .data(data.features)
                    .transition()
                    .style("fill", (d) => {
                        const tourism = findTourismByCountryName(tourismData, d.properties.name);
                        if (tourism && tourism[selectedYear] != "") return this.colors(tourism[selectedYear]);
                        else return "gray";
                    })
                    .style("stroke", (d) => {
                        if (d.properties.name == selectedCountry?.Country_Name) {
                            return "red";
                        } else {
                            return "black";
                        }
                    })
                    .style("stroke-width", (d) => {
                        if (d.properties.name == selectedCountry?.Country_Name) {
                            return "4px";
                        } else {
                            return "0.25px";
                        }
                    });
            }
        }

        class Sidebar {

            constructor() {
                this.yearLabel = d3.select("#yearLabel");
                this.countryLabel = d3.select("#countryLabel");
                this.tourismLabel = d3.select("#countryTourism");

                const yearInput = d3.select("#yearInput");
                yearInput.attr("value", selectedYear);
                yearInput.on("input", (e) => {
                    const year = e.target.valueAsNumber;
                    updateAll(year, selectedCountry)
                });


                const yearLabels = [];
                for (let i = 1995; i <= 2018; i++) {
                    yearLabels.push(i.toString());
                }

                const historyData = {
                    labels: yearLabels,
                    datasets: [{}]
                };

                const historyChartConfig = {
                    type: "bar",
                    data: historyData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                };

                this.historyChart = new Chart(document.getElementById("historyChart"), historyChartConfig);
            }

            update() {
                this.yearLabel.text("Year: " + selectedYear);

                if (selectedCountry) {
                    this.countryLabel.text(selectedCountry.Country_Name);
                    this.tourismLabel.text(
                        selectedCountry[selectedYear] ?
                            "Incoming tourists: " + d3.format(".3s")(selectedCountry[selectedYear])
                            : "No data"
                    );
                } else {
                    this.countryLabel.text("World");
                    this.tourismLabel.text("");
                }

                if (selectedYear == this.lastSelectedYear) {
                    if (selectedCountry) {
                        const yearData = [];
                        for (let i = 1995; i <= 2018; i++) {
                            yearData.push(selectedCountry[i]);
                        }

                        this.historyChart.data.datasets[0] = {
                            label: "Number of tourist arrivals",
                            backgroundColor: "lightblue",
                            data: yearData,
                        };
                    } else {
                        this.historyChart.data.datasets = [];
                    }
                }

                this.historyChart.update();
                this.lastSelectedYear = selectedYear;
            }
        }


        // Globals

        var selectedYear = 2000;
        var selectedCountry = null;

        const mapData = await loadData("countries-110m.json");
        const tourismData = await loadData("tourism.json");

        const worldMap = new WorldMap();
        const sidebar = new Sidebar();

        updateAll(selectedYear, selectedCountry);

    </script>

</body>

</html>